<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>echarts 3D earth</title>
    <style>
        html{height:100%;}
        body{
            height:100%;
            margin:0;
            background:url('img/timg.png') center/cover no-repeat;
        }
        #container{
            height:100%;
            box-sizing: border-box;
        }
    </style>
    <script type="text/javascript" src="js/echarts.min.js"></script>
    <script type="text/javascript" src="js/echarts-gl.min.js"></script>
    <script type="text/javascript" src="js/world.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
</head>
<body>
    <div id="container">

    </div>

    <script>
        //数据处理
        /*
            图中相关城市经纬度,根据你的需求添加数据
            关于国家的经纬度，可以用首都的经纬度或者其他城市的经纬度
            */


        /*
            记录下起点城市和终点城市的名称，以及权重
            i为终点城市，e为起点城市，以及该城市的权重，就是图上圆圈的大小
         */
        //地球的皮肤
        var canvas = document.createElement('canvas');
        var myChart = echarts.init(canvas, null, {
            width: 4096,
            height: 2048
        });
        var geoCoordMap = {
            '南宁': [108.479, 23.1152],
            '广州': [113.5107, 23.2196],
            '重庆': [107.7539, 30.1904],
            '芬兰': [24.909912, 60.169095],
            '美国': [-100.696295, 33.679979],
            '日本': [139.710164, 35.706962],
            '韩国': [126.979208, 37.53875],
            '瑞士': [7.445147, 46.956241],
            '东南亚': [117.53244, 5.300343],
            '澳大利亚': [135.193845, -25.304039],
            '德国': [13.402393, 52.518569],
            '英国': [-0.126608, 51.208425],
            '加拿大': [-102.646409, 59.994255]
        };
        let json = $.getJSON("data/all.json", function (data){
            //函数sel选择需要显示的数据，其中tim表示时间，范围是2015-2019，pla表示地点
            // dir表示方向，取值为"i"或"e"，cla表示类别，取值为"pos"、"neg"、"neu"
            //结果存在dat数组中
            var dser = [];  // 2D散点坐标系列
            var series = [];// 3D飞线
            var maxsize=50;//散点最大尺寸，即被分析的某国散点尺寸，其他国家散点尺寸按比例设置
            var pointsData=[]; //用于保存每一个需要被筛选的散点名称、经纬度和大小
            var pointsDatav=[]; //用于保存每一个需要被筛选的散点新闻数、经纬度，大小为1
            var vtol=0;//针对某国特定类型的流入或流出新闻总数

            //不同情况的线条颜色，正面为绿色，负面为红色，中性为蓝色
            var lcolor={pos:"#66CC99",neg:"#CC3333",neu:"#9ae5fc"};

            var convertData = function(d) {
                var res = [];
                var fromCoord = geoCoordMap[d.e];
                var toCoord = geoCoordMap[d.i];
                if(fromCoord && toCoord) {
                    res.push([fromCoord, toCoord]);
                }
                return res;
            }

            //函数功能为设置散点标签为pla，散点大小为size
            function setdserp(pla,size){
                pointsData.push({
                    name: pla,    //散点的name为国家名
                    value: geoCoordMap[pla], //散点的value为该点的经纬度
                    symbolSize: size   //散点对应的大小
                })
            }

            //函数功能为设置散点标签为size，散点大小为1
            function setdserv(pla,size){
                pointsDatav.push({
                    name: size,    //散点的name为国家名
                    value: geoCoordMap[pla], //散点的value为该点的经纬度
                    symbolSize: 1   //散点对应的大小
                })
            }

            //定义函数，筛选在特定时间，针对某一国家输入或输出特定感情取向的新闻流动数据
            function sel(tim,pla,dir,cla){//tim：时间 pla:国家 dir:流动方向 cla：感情取向
                var dat=[];
                var datain=data.timeBins[tim-2015].data;
                //console.log(datain);


               //筛选出符合条件的数据dat，并计算中心国的流动新闻总数vtol
                for(var i=0;i<datain.length;i++){
                    if(datain[i][dir]==pla&&datain[i].c==cla){
                        dat.push({
                            i:datain[i].i,
                            e:datain[i].e,
                            c:datain[i].c,
                            v:datain[i].v
                        });
                        //计算总输入值
                        vtol+=datain[i].v;
                    }
                }

                //设置被统计国家的地名散点
                setdserp(pla,maxsize);

                //设置被统计国家的数值散点
                setdserv(pla,vtol);

                //对关联过国的新闻流动方向是相反的
                var dirv=(dir=="i")? "e":"i";

                //关联的散点
                for(var i=0;i<dat.length;i++)
                {
                    val=dat[i].v; //每个被关注流动的实际数值
                    //按比例计算散点的大小
                    size=Math.round(maxsize*val/vtol);
                    pla=dat[i][dirv];

                    //设置每个关联国家的地名散点
                    setdserp(pla,size);

                    //设置每个关联国家的数值散点
                    setdserv(pla,val);

                }
                return dat;
            }
            //取数据为****年，国家为**，方向（i：输入，e：输入）
            // 类型（正面：pos，负面：neg，中性：neu)
            var Data=sel(2017,"南宁","i","neu");
            console.log(Data);

            //添加散点数据，第一组为标注地名的散点
            dser.push(
                //被统计国家对应的散点
                {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    zlevel: 3,
                    rippleEffect: {
                        brushType: 'stroke'
                    },
                    label: {
                        fontSize:24, //标签的字号
                        show: true,
                        position: 'left',
                        formatter: '{b}'  //标签内容格式器，a：系列名，b:数据名，c：数据值
                    },
                    itemStyle: {
                        normal: {
                            color: '#FFF'  //散点的颜色
                        }
                    },
                    data:pointsData
                }

            );

            //添加散点数据，第二组为标注数值的散点
            dser.push(
                {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    zlevel: 3,
                    rippleEffect: {
                        brushType: 'stroke'
                    },
                    label: {
                        fontSize:30, //标签的字号
                        show: true,
                        position: [30,0],
                        formatter: '{b}',  //标签内容格式器，a：系列名，b:数据名，c：数据值
                        color: '#FFF',
                        fontFamily: 'Arial',
                        borderWidth: 3,
                        backgroundColor: 'rgba(0,23,11,0.3)',
                        padding: [5, 10, 10, 5],
                        lineHeight: 30
                    },
                    itemStyle: {
                        normal: {
                            color: '#FFF'  //散点的颜色
                        }
                    },
                    data:pointsDatav
                }
            );

            //统计飞线数据
            for(var i=0;i<Data.length;i++)
            {
                series.push(
                    {
                        type: 'lines3D',
                        effect: {
                            show: true,
                            period: 3,//周期，数值越小越块
                            trailLength: Data[i].v/vtol//尾部阴影，范围0-1，用当前线条v值除以总v值，当前流动占总数的比例
                        },
                        lineStyle: {//航线的视图效果
                            color: lcolor[Data[i].c],
                            width: 1,
                            opacity: 0.6
                        },
                        data: convertData(Data[i])// 特效的起始、终点位置，一个二维数组，相当于coords: convertData(item[1])
                    })
            }

            console.log(dser);
            console.log(series);

            myChart.setOption({
                backgroundColor: 'rgba(3,28,72,0.3)',
                title: {
                    show:true
                },
                geo: {
                    type: 'map',
                    map: 'world',
                    left:0,
                    top:0,
                    right: 0,
                    bottom: 0,
                    boundingCoords: [[-180, 90], [180, -90]],
                    zoom:0,
                    roam: false,
                    itemStyle: {
                        borderColor:'#000d2d',
                        normal: {
                            areaColor: '#2455ad',
                            borderColor:'#000c2d'
                        },
                        emphasis: {
                            areaColor: '#357cf8'
                        }
                    },
                    label:{
                        fontSize:24
                    }
                },
                series:dser
            });


            //3D地球
            option = {
                backgroundColor: 'rgba(0,0,0,0)',//canvas的背景颜色
                globe: {
                    baseTexture:myChart,
                    top: 'middle',
                    left: 'center',
                    displacementScale: 0,
                    environment:'none',
                    shading: 'color',
                    viewControl: {
                        distance:240,
                        autoRotate: true
                    }
                },
                roam: true,
                series:series
            };
            echarts.init(document.getElementById("container")).setOption(option, true);
        });
    </script>
</body>
</html>














